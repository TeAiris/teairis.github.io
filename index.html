<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AlphaTab — Served over localhost</title>

  <!-- Use non-minified alphaTab.js -->
  <script src="./AlphaTabLib/dist/alphaTab.js"></script>

  <style>
    :root { --fg:#111; --bg:#fff; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, Arial, sans-serif; color:var(--fg); background:var(--bg); }
    #sheet { width: 100vw; height: 72vh; border-bottom:1px solid #ddd; }
    .controls { display:flex; gap:8px; align-items:center; padding:10px; flex-wrap:wrap; }
    button, select, label, input { font: inherit; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  </style>
</head>
<body>
  <div id="sheet"></div>

  <div class="controls">
    <button id="play" disabled>Play</button>
    <button id="stop" disabled>Stop</button>

    <label>SoundFont:
      <select id="sfSelect">
        <option value="mallets" selected>mallets.sf2 (local)</option>
        <option value="sonivox">sonivox.sf2 (local)</option>
      </select>
    </label>

    <label style="margin-left:12px;">Tempo:
      <input id="tempo" type="range" min="40" max="220" value="110" style="width:160px;">
      <span id="tempoVal" class="mono">110</span> BPM
    </label>

    <span id="status" class="mono" style="margin-left:auto;">Loading…</span>
  </div>

  <script>
  (function(){
    const sheet    = document.getElementById('sheet');
    const btnPlay  = document.getElementById('play');
    const btnStop  = document.getElementById('stop');
    const sfSelect = document.getElementById('sfSelect');
    const tempoSl  = document.getElementById('tempo');
    const tempoVal = document.getElementById('tempoVal');
    const statusEl = document.getElementById('status');

    const setStatus = (m) => { statusEl.textContent = m; };
    const fmt = (ms) => { const s = Math.floor(ms/1000), m = Math.floor(s/60), r = s - m*60; return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`; };

    // Normal relative URLs – all from the same http://127.0.0.1:<port> origin
    const WORKLET_URL = "./AlphaTabLib/dist/alphaTab.worklet.mjs";
    const WORKER_URL  = "./AlphaTabLib/dist/alphaTab.worker.mjs";
    const SF_MAP = {
      mallets: "./AlphaTabLib/dist/soundfont/mallets.sf2",
      sonivox: "./AlphaTabLib/dist/soundfont/sonivox.sf2"
    };

    const makeTex = (bpm) => `
\\title "AlphaTab (localhost)"
\\subtitle "Worker/Worklet + local SF2 over HTTP"
\\tempo ${bpm} .
\\track "Marimba"
\\instrument marimba
:4 (C4) D4 E4 F4 | (G4) A4 B4 C5 |
:8 C5 B4 A4 G4 F4 E4 D4 C4 | :4 C4 R R R
`;

    let api;
    function unlockAudio(){
      try {
        const ctx = alphaTab.platform?.web?.AudioContextProvider?.context;
        if (ctx && ctx.state === 'suspended') ctx.resume();
      } catch {}
    }
    ['pointerdown','mousedown','touchstart','keydown','click'].forEach(evt =>
      window.addEventListener(evt, unlockAudio, { once:true, passive:true })
    );

    // Create AlphaTab with explicit worker/worklet URLs
    api = new alphaTab.AlphaTabApi(sheet, {
      core: { tex: true },
      player: {
        enablePlayer: true,
        enableCursor: true,
        workletScript: WORKLET_URL,
        workerScript:  WORKER_URL,
        soundFont:     SF_MAP.mallets,
        scrollElement: sheet,
        schedulerLookAhead: 20
      }
    });

    api.error.on(e => {
      console.error('[AlphaTab error]', e);
      setStatus('Error: ' + (e?.message || e));
      // Worklet fallback
      if (String(e?.message || e).toLowerCase().includes('worklet')) {
        try {
          const s = api.settings || {};
          s.player = s.player || {};
          s.player.workletScript = null;
          api.updateSettings(s);
          api.render();
          setStatus('Retrying with Worker synth…');
        } catch {}
      }
    });

    api.soundFontLoad.on(e => {
      const pct = Math.floor((e.loaded / e.total) * 100);
      setStatus(`Loading soundfont… ${pct}%`);
    });

    api.playerReady.on(() => {
      setStatus('Ready');
      btnPlay.disabled = false;
      btnStop.disabled = false;
    });

    api.playerStateChanged.on(e => {
      const playing = e.state === alphaTab.synth.PlayerState.Playing;
      btnPlay.textContent = playing ? 'Pause' : 'Play';
    });

    api.playerPositionChanged.on(e => setStatus(`Pos ${fmt(e.currentTime)} / ${fmt(e.endTime)}`));
    api.scoreLoaded.on(() => { try { api.loadMidiForScore(); } catch {} });

    btnPlay.addEventListener('click', () => { unlockAudio(); api.playPause(); });
    btnStop.addEventListener('click',  () => api.stop());

    sfSelect.addEventListener('change', () => {
      const key = sfSelect.value;
      const url = SF_MAP[key];
      try {
        if (typeof api.loadSoundFontFromUrl === 'function') {
          api.loadSoundFontFromUrl(url);
        } else {
          const s = api.settings || {};
          s.player = s.player || {};
          s.player.soundFont = url;
          api.updateSettings(s);
          api.render();
        }
        setStatus(`SoundFont: ${key}`);
      } catch (e) { setStatus('SF switch error: ' + (e?.message || e)); }
    });

    tempoSl.addEventListener('input', () => { tempoVal.textContent = tempoSl.value; });
    const debounce = (fn, d=150) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),d); }; };
    tempoSl.addEventListener('change', debounce(() => {
      api.tex(makeTex(parseInt(tempoSl.value,10) || 110));
    }, 120));

    // Initial render
    api.tex(makeTex(parseInt(tempoSl.value,10) || 110));
  })();
  </script>
</body>
</html>
